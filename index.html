<center>
	<button onclick="start()" style="height:200px; width:500px;">Start!</button>
	<input id="number" type="text" style="height:100px; width:500px;  font-size:50px;">
	<input id="series" type="text" style="height:100px; width:500px;  font-size:50px;">
</center>

<div id="text">

</div>

<video id="video" width="100%" height="70%" autoplay style="visibility:hidden;"></video><br>
<canvas id="preview" width="1024" height="1000" style="visibility:hidden;"></canvas>

<script>
	var canvas = document.createElement("canvas")
	var video = document.getElementById('video')
	var div = document.querySelector('#text')


	var loading = false;
	var snapping = false;
	var localStream;

	var start = () => {
		navigator.mediaDevices.getUserMedia({
			video: {
				width: { ideal: 1024 },
				height: { ideal: 768 }
			}
		}).then(stream => {
			localStream = stream;
			snapping = true;
			video.srcObject = stream;
			video.style.visibility = "visible";
		}).catch(log);
	}

	var snap = () => {
		if (snapping) {
			canvas.width = video.videoWidth;
			canvas.height = video.videoHeight;

			canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
			preview.getContext('2d').drawImage(canvas, 0, video.videoHeight / 5, video.videoWidth, video.videoHeight - video.videoHeight / 2, 0, video.videoHeight / 4, video.videoWidth, video.videoHeight - video.videoHeight / 2);

			let data = preview.toDataURL().split(',')[1];

			const dataToSend = JSON.stringify({ "image": data });
			let dataReceived = "";
			if (!loading) {
				loading = true;

				fetch("https://mrz-proxy.herokuapp.com/process", {
					method: "post",
					headers: { "Content-Type": "application/json" },
					body: dataToSend,
					rejectUnauthorized: false,
					requestCert: true,
					agent: false
				}).then(resp => {
					if (resp.status === 200) {
						return resp.json()
					} else {
						console.log("Status: " + resp.status)
						return Promise.reject("server")
					}
				}).then(dataJson => {
					if (!dataJson['error']) {
						//if (dataJson['valid_score'] > 5) 
						//document.getElementById("text").innerHTML = JSON.stringify(dataJson);
						snapping = false;
						video.style.visibility = "hidden";
						document.getElementById("number").value = dataJson['number'];
						document.getElementById("series").value = dataJson['personal_number'];
						localStream.getTracks().forEach((track) => {
							track.stop();
						});
					}
					loading = false;
				})
					.catch(err => {
						loading = false;
						if (err === "server") return
						console.log(err)
					})
			}
		}
	}

	setInterval(snap, 1000);

	var log = msg => div.innerHTML += "<br>" + msg;
</script>








<!-- <canvas id="canvas" width="640" height="480">
    <p>Ваш браузер не поддерживает рисование.</p>
</canvas>

<input id="photo" type="file" name="image" accept="image/*" capture>

<script type="text/javascript" src="index.js"></script> -->