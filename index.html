<html>

<head></head>

<body>

	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
		integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>

	<center>
		<button onclick="start()" style="height:200px; width:500px;">Start!</button>
		<input id="number" type="text" style="height:100px; width:500px;  font-size:50px;">
		<input id="series" type="text" style="height:100px; width:500px;  font-size:50px;">
	</center>

	<div id="text">

	</div>
	<style>
		.reader {
			position: fixed;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			z-index: 10000000;
		}

		.reader .top {
			position: absolute;
			left: 10px;
			background: rgba(0, 0, 0, .4);
			right: 10px;
			top: 0;
			height: calc(50% - 30px);
			width: calc(100% - 20px);
		}

		.reader .bottom {
			position: absolute;
			left: 10px;
			background: rgba(0, 0, 0, .4);
			right: 10px;
			bottom: 0;
			height: calc(50% - 30px);
			width: calc(100% - 20px);
		}

		.reader .left {
			position: absolute;
			bottom: 0;
			background: rgba(0, 0, 0, .4);
			left: 0;
			height: 100%;
			width: 10px;
		}

		.reader .right {
			position: absolute;
			bottom: 0;
			background: rgba(0, 0, 0, .4);
			right: 0;
			height: 100%;
			width: 10px;
		}

		#preview {
			left: 0;
			right: 0;
			visibility: hidden;
			display: none;
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			width: 100%;
		}
	</style>
	<div class="reader" style="display: none;">
		<div class="left"></div>
		<div class="right"></div>
		<div class="top"></div>
		<div class="bottom"></div>
		<video id="video" width="100%" height="100%" autoplay="" style="visibility:hidden; object-fit: cover;"></video>
	</div>
	<canvas id="preview" height="200px" style=""></canvas>





	<script src="highlight.min.js"></script>

	<script src="html5-qrcode.min.js"></script>

	<script>
		var canvas = document.createElement("canvas");
		var video = document.getElementById('video')


		var loading = false;
		var snapping = false;
		var localStream;

		var start = () => {
			$('.reader, #preview').show();
			setTimeout(() => {
				navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1024 }, height: { ideal: 768 }, facingMode: { exact: "environment" }, frameRate: { ideal: 10, max: 15 } } }).then(stream => {
					localStream = stream;
					snapping = true;
					video.srcObject = stream;
					video.style.visibility = "visible";
				}).catch(log);
			}, 0)
		}

		var snap = () => {
			if (snapping) {
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;

				canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
				// preview.getContext('2d').drawImage(canvas, 0, video.videoHeight / 5, video.videoWidth, video.videoHeight - video.videoHeight / 2, 0, video.videoHeight / 4, video.videoWidth, video.videoHeight - video.videoHeight / 2);
				preview.getContext('2d').drawImage(canvas, 0, video.videoHeight / 2.5, video.videoWidth, 140, 0, 0, video.videoWidth, 140);
				let data = preview.toDataURL().split(',')[1];

				const dataToSend = JSON.stringify({ "image": data });
				let dataReceived = "";
				if (!loading) {
					loading = true;

					fetch("https://mrz-proxy.herokuapp.com/process", {
						method: "post",
						headers: { "Content-Type": "application/json" },
						body: dataToSend,
						rejectUnauthorized: false,
						requestCert: true,
						agent: false
					}).then(resp => {
						if (resp.status === 200) {
							return resp.json()
						} else {
							console.log("Status: " + resp.status)
							return Promise.reject("server")
						}
					}).then(dataJson => {
						if (!dataJson['error']) {
							snapping = false;
							video.style.visibility = "hidden";
							$('[name=pinpp]').val(dataJson['personal_number'])
							$('[name=series]').val(dataJson['number'].replace(/[0-9]/gi, ''));
							$('[name=document]').val(dataJson['number'].replace(/[A-Z]/gi, ''));
							$('.enter-pinfl button').removeAttr('disabled')
							localStream.getTracks().forEach((track) => {
								track.stop();
							});
							$('.reader, #preview').hide();
						}
						loading = false;
					})
						.catch(err => {
							loading = false;
							if (err === "server") return
							console.log(err)
						})
				}
			}
		}

		setInterval(snap, 500);

		var log = msg => console.log(msg);
	</script>


</body>

</html>